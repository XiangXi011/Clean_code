<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>洁净度测量系统 (工作台版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .tab-button { transition: all 0.2s ease-in-out; }
        .tab-button-active { color: #2563eb; background-color: #dbeafe; font-weight: 600; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
        .modal-leave-active { opacity: 0; transform: scale(0.95); transition: all 0.2s ease-in; }
        .progress-bar-inner { 
            transition: width 0.5s ease-in-out; 
            background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.15) 50%, rgba(255, 255, 255, 0.15) 75%, transparent 75%, transparent);
            background-size: 40px 40px;
        }
        .toast-enter { opacity: 0; transform: translateY(-20px); }
        .toast-enter-active { opacity: 1; transform: translateY(0); transition: all 0.3s ease-out; }
        .toast-leave-active { opacity: 0; transform: translateY(-20px); transition: all 0.3s ease-in; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="max-w-lg mx-auto bg-white shadow-lg min-h-screen">
        
        <header class="bg-white border-b border-gray-200 p-4 sticky top-0 z-10">
            <h1 class="text-xl font-bold text-gray-800">洁净度测量系统</h1>
        </header>

        <nav class="flex justify-around bg-white p-2 border-b sticky top-[68px] z-10">
            <button data-view="dashboard" class="tab-button flex-1 text-center py-2 px-4 rounded-md font-semibold text-gray-600">看板</button>
            <button data-view="plan" class="tab-button flex-1 text-center py-2 px-4 rounded-md font-semibold text-gray-600">今日计划</button>
            <button data-view="furnace" class="tab-button flex-1 text-center py-2 px-4 rounded-md font-semibold text-gray-600">固化炉</button>
            <button data-view="history" class="tab-button flex-1 text-center py-2 px-4 rounded-md font-semibold text-gray-600">历史记录</button>
        </nav>
        
        <main class="p-4" id="main-content">
            <!-- 视图会在这里动态渲染 -->
        </main>

    </div>

    <!-- 数据录入模态框 -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold text-gray-800">记录测量数据</h3>
            <p id="modal-task-name" class="text-gray-600 mt-1 mb-6"></p>
            <div class="space-y-4">
                <div><label for="value-03" class="block text-sm font-medium text-gray-700">0.3um 测量值</label><input type="number" id="value-03" placeholder="请输入0.3um数值" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <div><label for="value-05" class="block text-sm font-medium text-gray-700">0.5um 测量值</label><input type="number" id="value-05" placeholder="请输入0.5um数值" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <div><label for="value-50" class="block text-sm font-medium text-gray-700">5.0um 测量值</label><input type="number" id="value-50" placeholder="请输入5.0um数值" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
            </div>
            <div class="mt-8 flex justify-end space-x-3"><button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">取消</button><button id="modal-submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 flex items-center justify-center min-w-[80px]"><span class="btn-text">提交</span><span class="loader hidden"></span></button></div>
        </div>
    </div>

    <!-- 全局通知 Toast -->
    <div id="toast" class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg hidden toast-enter max-w-sm">
        <div class="flex items-center"><i data-lucide="check-circle" class="w-5 h-5 mr-2 flex-shrink-0"></i><span id="toast-message" class="break-words"></span></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = '';
        let state = { currentView: 'dashboard', selectedTask: null, allFurnaces: [] };

        const elements = {
            mainContent: document.getElementById('main-content'),
            tabButtons: document.querySelectorAll('.tab-button'),
            modal: document.getElementById('modal'),
            modalSubmit: document.getElementById('modal-submit'),
            modalCancel: document.getElementById('modal-cancel'),
            modalTaskName: document.getElementById('modal-task-name'),
            modalValue03: document.getElementById('value-03'),
            modalValue05: document.getElementById('value-05'),
            modalValue50: document.getElementById('value-50'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
        };

        const api = {
            get: async (endpoint) => {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: `服务器错误，状态码: ${response.status}` }));
                    throw new Error(errorData.error || `服务器错误: ${response.status}`);
                }
                return response.json();
            },
            post: async (endpoint, body) => {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                return response.json();
            }
        };

        const render = async () => {
            updateTabs();
            elements.mainContent.innerHTML = '<div class="text-center py-10"><div class="loader inline-block"></div></div>';
            
            try {
                let viewHTML = '';
                switch (state.currentView) {
                    case 'dashboard': viewHTML = await renderDashboardView(); break;
                    case 'plan': viewHTML = await renderPlanView(); break;
                    case 'furnace': viewHTML = await renderFurnaceView(); break;
                    case 'history': viewHTML = renderHistoryView(); break;
                }
                elements.mainContent.innerHTML = viewHTML;
            } catch (error) {
                console.error("渲染视图时发生错误:", error);
                elements.mainContent.innerHTML = createErrorStateHTML(error.message);
            }
            lucide.createIcons();
        };
        
        const renderDashboardView = async () => {
            const data = await api.get('/api/dashboard');
            const daily = data.daily || { total: 0, completed: 0, percentage: 0 };
            const furnace = data.furnace || { total: 0, completed: 0, percentage: 0 };

            return `
                <div class="space-y-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex items-center">
                            <div class="bg-blue-100 p-3 rounded-full">
                                <i data-lucide="clipboard-list" class="w-6 h-6 text-blue-600"></i>
                            </div>
                            <div class="ml-4">
                                <h2 class="text-lg font-semibold text-gray-800">今日任务进度</h2>
                                <p class="text-sm text-gray-500">常规测量点任务</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="flex justify-between items-end">
                                 <span class="text-3xl font-bold text-gray-800">${daily.completed}</span>
                                 <span class="text-gray-500 font-medium">/ ${daily.total} 项</span>
                            </div>
                            <div class="mt-2 bg-gray-200 rounded-full h-4 overflow-hidden">
                                <div class="progress-bar-inner bg-blue-500 h-full" style="width: ${daily.percentage.toFixed(2)}%;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex items-center">
                            <div class="bg-green-100 p-3 rounded-full">
                                <i data-lucide="box" class="w-6 h-6 text-green-600"></i>
                            </div>
                            <div class="ml-4">
                                <h2 class="text-lg font-semibold text-gray-800">本月固化炉进度</h2>
                                <p class="text-sm text-gray-500">固化炉周期性测量</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <div class="flex justify-between items-end">
                                 <span class="text-3xl font-bold text-gray-800">${furnace.completed}</span>
                                 <span class="text-gray-500 font-medium">/ ${furnace.total} 台</span>
                            </div>
                            <div class="mt-2 bg-gray-200 rounded-full h-4 overflow-hidden">
                                <div class="progress-bar-inner bg-green-500 h-full" style="width: ${furnace.percentage.toFixed(2)}%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

       const renderPlanView = async () => {
            const summary = await api.get('/api/tasks/summary');
            const { furnace_summary, other_tasks } = summary;

            if (other_tasks.length === 0 && furnace_summary.total === 0) {
                return createEmptyStateHTML('今日所有计划已全部完成！');
            }

            let content = '<h2 class="text-lg font-semibold text-gray-700 mb-4">今日计划</h2>';

            if (furnace_summary.total > 0) {
                content += `
                    <div class="bg-gray-50 border border-dashed rounded-lg p-3 mb-6">
                        <div class="flex items-center">
                            <div class="mr-4 text-green-500 flex-shrink-0">
                                <i data-lucide="box" class="w-6 h-6"></i>
                            </div>
                            <div class="truncate">
                                <p class="font-semibold text-gray-800 truncate">今日固化炉计划: ${furnace_summary.total} 台</p>
                                <p class="text-sm text-gray-500">已完成: ${furnace_summary.completed} 台 (请在“固化炉”页面操作)</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            content += '<h3 class="text-md font-semibold text-gray-600 mb-3">常规测量点任务</h3>';
            if (other_tasks.length > 0) {
                content += `<ul class="space-y-3">${other_tasks.map(createTaskItemHTML).join('')}</ul>`;
            } else {
                content += createEmptyStateHTML('今日常规测量点已全部完成！');
            }

            return content;
        };
        
        const renderFurnaceView = async () => {
            // Always fetch the latest furnace data when switching to this view
            state.allFurnaces = await api.get('/api/furnaces/all_status');
            
            return `
                <div class="relative mb-4">
                     <input type="search" id="furnace-search" placeholder="搜索固化炉编号..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                     <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="search" class="w-5 h-5 text-gray-400"></i>
                     </div>
                </div>
                <div id="furnace-lists-container">
                    ${generateFurnaceListsHTML(state.allFurnaces, '')}
                </div>
            `;
        };
        
        const generateFurnaceListsHTML = (furnaces, searchTerm) => {
            const lowerCaseSearchTerm = searchTerm.toLowerCase();
            const filteredFurnaces = furnaces.filter(f => f.name.toLowerCase().includes(lowerCaseSearchTerm));
            
            const pendingFurnaces = filteredFurnaces.filter(f => !f.measured_this_month);
            const completedFurnaces = filteredFurnaces.filter(f => f.measured_this_month);

            return `
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 mb-3">本月待测 (${pendingFurnaces.length})</h2>
                    <ul class="space-y-3">
                        ${pendingFurnaces.map(f => createTaskItemHTML({
                            id: f.furnace_id, type: '固化炉', name: f.name,
                            subtext: f.last_measured ? `上次: ${f.last_measured}` : '从未测量',
                            is_completed: false
                        })).join('')}
                    </ul>
                    ${pendingFurnaces.length === 0 ? createEmptyStateHTML('本月固化炉已全部测量或无匹配项！') : ''}
                </div>
                <div class="mt-8">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3">本月已测 (${completedFurnaces.length})</h2>
                    <ul class="space-y-3">
                         ${completedFurnaces.map(f => createTaskItemHTML({
                            id: f.furnace_id, type: '固化炉', name: f.name,
                            subtext: `本次: ${f.last_measured}`,
                            is_completed: true
                        })).join('')}
                    </ul>
                     ${completedFurnaces.length === 0 && searchTerm ? '<p class="text-sm text-center text-gray-500 py-4">沒有匹配的已测记录</p>' : ''}
                     ${completedFurnaces.length === 0 && !searchTerm ? '<p class="text-sm text-center text-gray-500 py-4">暂无已测记录</p>' : ''}
                </div>
            `;
        };

        const renderHistoryView = () => {
            const today = new Date().toISOString().split('T')[0];
            return `
                <div class="space-y-4">
                    <div>
                        <label for="start-date" class="block text-sm font-medium text-gray-700">开始日期</label>
                        <input type="date" id="start-date" value="${today}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                    </div>
                    <div>
                        <label for="end-date" class="block text-sm font-medium text-gray-700">结束日期</label>
                        <input type="date" id="end-date" value="${today}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3">
                    </div>
                    <button id="query-history-btn" class="w-full px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700">查询</button>
                    <div id="history-results" class="mt-4"></div>
                </div>
            `;
        };
        
        // --- 事件处理函数 ---
        const handleTabClick = (view) => { state.currentView = view; render(); };
        
        const handleHistoryQuery = async () => {
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const resultsContainer = document.getElementById('history-results');
            if (!startDate || !endDate) {
                showToast("请选择开始和结束日期", true);
                return;
            }
            resultsContainer.innerHTML = '<div class="text-center py-10"><div class="loader inline-block"></div></div>';
            try {
                const results = await api.get(`/api/history?start_date=${startDate}&end_date=${endDate}`);
                if (results.length === 0) {
                    resultsContainer.innerHTML = createEmptyStateHTML('该时间段内没有历史记录。');
                } else {
                    resultsContainer.innerHTML = `<ul class="space-y-3">${results.map(createHistoryItemHTML).join('')}</ul>`;
                }
            } catch (error) {
                resultsContainer.innerHTML = createErrorStateHTML(error.message);
            }
            lucide.createIcons();
        };

        const handleSubmit = async () => { 
            const submitBtn = elements.modalSubmit;
            const btnText = submitBtn.querySelector('.btn-text');
            const loader = submitBtn.querySelector('.loader');

            btnText.classList.add('hidden');
            loader.classList.remove('hidden');
            submitBtn.disabled = true;

            try {
                const payload = {
                    task_id: state.selectedTask.type !== '固化炉' ? state.selectedTask.id : null,
                    furnace_id: state.selectedTask.type === '固化炉' ? state.selectedTask.id : null,
                    value_03: elements.modalValue03.value,
                    value_05: elements.modalValue05.value,
                    value_50: elements.modalValue50.value,
                };
                 console.log("正在提交数据...", payload);
                const result = await api.post('/api/results/add', payload);

                if (result.success) {
                    console.log("数据提交成功, API返回:", result);
                    submitBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    submitBtn.classList.add('bg-green-500');
                    loader.classList.add('hidden');
                    btnText.innerHTML = `<i data-lucide="check" class="w-5 h-5"></i>`;
                    lucide.createIcons();
                    btnText.classList.remove('hidden');

                    showToast("数据提交成功！");

                    setTimeout(() => {
                        console.log("1秒后, 正在关闭对话框并刷新界面...");
                        closeModal();
                        if (state.currentView === 'furnace' || state.selectedTask.type === '固化炉') {
                            state.allFurnaces = []; 
                        }
                        render(); 
                    }, 1000);

                } else {
                    console.error("提交失败, API返回错误信息:", result.error);
                    throw new Error(result.error || "提交失败");
                }
            } catch (error) {
                console.error("提交过程中捕获到错误:", error);
                showToast(error.message, true);
                btnText.innerHTML = '提交';
                btnText.classList.remove('hidden');
                loader.classList.add('hidden');
                submitBtn.disabled = false;
            }
        };
        
        // --- 统一的事件监听 ---
        const addEventListeners = () => {
            elements.tabButtons.forEach(button => button.addEventListener('click', () => handleTabClick(button.dataset.view)));
            elements.modalSubmit.addEventListener('click', handleSubmit);
            elements.modalCancel.addEventListener('click', closeModal);

            elements.mainContent.addEventListener('click', (e) => {
                const recordBtn = e.target.closest('.record-btn');
                if (recordBtn && !recordBtn.disabled) {
                    state.selectedTask = { id: recordBtn.dataset.taskId, type: recordBtn.dataset.taskType, name: recordBtn.dataset.taskName };
                    elements.modalTaskName.textContent = `为 [${state.selectedTask.name}] 记录`;
                    [elements.modalValue03, elements.modalValue05, elements.modalValue50].forEach(el => el.value = '');
                    openModal();
                    return;
                }
                const queryBtn = e.target.closest('#query-history-btn');
                if (queryBtn) {
                    handleHistoryQuery();
                }
            });
            
            elements.mainContent.addEventListener('input', (e) => {
                if (e.target.id === 'furnace-search') {
                    const searchTerm = e.target.value;
                    const container = document.getElementById('furnace-lists-container');
                    if (container) {
                        container.innerHTML = generateFurnaceListsHTML(state.allFurnaces, searchTerm);
                        lucide.createIcons();
                    }
                }
            });
        };

        // --- 辅助函数和HTML模板 ---
        const createTaskItemHTML = (task) => {
            const iconMap = { '大环境': 'building-2', '层流棚': 'wind', '加硬机': 'server', '固化炉': 'box' };
            const taskId = task.task_id || task.id;
            const taskName = task.point_name || task.name;
            const taskType = task.location_type || task.type;
            
            const isCompleted = task.status === '已完成' || task.is_completed;
            const buttonHTML = isCompleted
                ? `<button disabled class="flex-shrink-0 ml-2 px-4 py-2 bg-gray-300 text-gray-500 text-sm font-semibold rounded-md cursor-not-allowed">已录入</button>`
                : `<button data-task-id="${taskId}" data-task-type="${taskType}" data-task-name="${taskName}" class="record-btn flex-shrink-0 ml-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold rounded-md">记录</button>`;

            return `<li class="bg-white border border-gray-200 rounded-lg p-3 flex items-center justify-between"><div class="flex items-center min-w-0"><div class="mr-4 text-blue-500"><i data-lucide="${iconMap[taskType] || 'clipboard-list'}" class="w-6 h-6"></i></div><div class="truncate"><p class="font-semibold text-gray-800 truncate">${taskName}</p><p class="text-sm text-gray-500">${task.subtext || '待测量'}</p></div></div>${buttonHTML}</li>`;
        };
        
        const createHistoryItemHTML = (item) => {
            const iconMap = { '大环境': 'building-2', '层流棚': 'wind', '加硬机': 'server', '固化炉': 'box' };
            return `
                <li class="bg-white border border-gray-200 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center min-w-0">
                            <div class="mr-4 text-gray-500">
                                <i data-lucide="${iconMap[item.location_type] || 'clipboard-check'}" class="w-6 h-6"></i>
                            </div>
                            <div class="truncate">
                                <p class="font-semibold text-gray-800 truncate">${item.point_name}</p>
                                <p class="text-sm text-gray-500">${item.measure_time}</p>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 grid grid-cols-3 text-center border-t pt-2">
                        <div><p class="text-xs text-gray-500">0.3um</p><p class="font-mono text-gray-800">${item.value_03}</p></div>
                        <div><p class="text-xs text-gray-500">0.5um</p><p class="font-mono text-gray-800">${item.value_05}</p></div>
                        <div><p class="text-xs text-gray-500">5.0um</p><p class="font-mono text-gray-800">${item.value_50}</p></div>
                    </div>
                </li>
            `;
        };
        
        const createEmptyStateHTML = (text) => `<div class="text-center py-10"><i data-lucide="check-circle" class="w-16 h-16 text-green-500 mx-auto"></i><p class="mt-4 font-semibold text-gray-700">${text}</p></div>`;
        const createErrorStateHTML = (text) => `<div class="text-center py-10"><i data-lucide="alert-triangle" class="w-16 h-16 text-red-500 mx-auto"></i><p class="mt-4 font-semibold text-gray-700">加载失败</p><p class="mt-2 text-sm text-gray-500 break-words">${text}</p></div>`;
        
        const showToast = (message, isError = false) => {
            elements.toastMessage.textContent = message;
            const icon = elements.toast.querySelector('i');
            if (isError) {
                elements.toast.classList.remove('bg-green-500');
                elements.toast.classList.add('bg-red-500');
                icon.dataset.lucide = 'alert-circle';
            } else {
                elements.toast.classList.remove('bg-red-500');
                elements.toast.classList.add('bg-green-500');
                icon.dataset.lucide = 'check-circle';
            }
            lucide.createIcons();
            elements.toast.classList.remove('hidden', 'toast-enter');
            void elements.toast.offsetWidth; 
            elements.toast.classList.add('toast-enter-active');
            
            setTimeout(() => {
                elements.toast.classList.remove('toast-enter-active');
                elements.toast.classList.add('toast-leave-active');
                setTimeout(() => elements.toast.classList.add('hidden'), 300);
            }, 3000);
        };

        const openModal = () => { 
            const submitBtn = elements.modalSubmit;
            const btnText = submitBtn.querySelector('.btn-text');
            submitBtn.disabled = false;
            submitBtn.classList.remove('bg-green-500');
            submitBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
            btnText.innerHTML = '提交';

            elements.modal.classList.remove('hidden', 'modal-enter'); 
            void elements.modal.offsetWidth;
            elements.modal.classList.add('modal-enter-active');
        };
        const closeModal = () => { 
            elements.modal.classList.remove('modal-enter-active');
            elements.modal.classList.add('modal-leave-active');
            setTimeout(() => elements.modal.classList.add('hidden'), 200);
        };
        
        const updateTabs = () => {
            elements.tabButtons.forEach(button => {
                button.classList.toggle('tab-button-active', button.dataset.view === state.currentView);
            });
        };

        const init = () => {
            addEventListeners();
            handleTabClick('dashboard');
        };
        init();
    });
    </script>
</body>
</html>

