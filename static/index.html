<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>洁净度测量系统 (工作台版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .tab-button-active { color: #2563eb; background-color: #dbeafe; font-weight: 600; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
        .modal-leave-active { opacity: 0; transform: scale(0.95); transition: all 0.2s ease-in; }
        .progress-bar-inner { transition: width 0.5s ease-in-out; }
        .toast-enter { opacity: 0; transform: translateY(-20px); }
        .toast-enter-active { opacity: 1; transform: translateY(0); transition: all 0.3s ease-out; }
        .toast-leave-active { opacity: 0; transform: translateY(-20px); transition: all 0.3s ease-in; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">

    <div id="app" class="max-w-lg mx-auto bg-white shadow-lg min-h-screen">
        
        <header class="bg-white border-b border-gray-200 p-4 sticky top-0 z-10">
            <h1 class="text-xl font-bold text-gray-800">洁净度测量系统</h1>
        </header>

        <nav class="flex justify-around bg-white p-2 border-b sticky top-[68px] z-10">
            <button data-view="dashboard" class="tab-button flex-1 text-center py-2 px-4 rounded-md font-semibold text-gray-600">看板</button>
            <button data-view="plan" class="tab-button flex-1 text-center py-2 px-4 rounded-md font-semibold text-gray-600">今日计划</button>
            <button data-view="furnace" class="tab-button flex-1 text-center py-2 px-4 rounded-md font-semibold text-gray-600">固化炉</button>
            <button data-view="history" class="tab-button flex-1 text-center py-2 px-4 rounded-md font-semibold text-gray-600">历史记录</button>
        </nav>
        
        <main class="p-4" id="main-content">
            <!-- 视图会在这里动态渲染 -->
        </main>

    </div>

    <!-- 数据录入模态框 -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden modal-enter">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <h3 class="text-lg font-bold text-gray-800">记录测量数据</h3>
            <p id="modal-task-name" class="text-gray-600 mt-1 mb-6"></p>
            <div class="space-y-4">
                <div><label for="value-03" class="block text-sm font-medium text-gray-700">0.3um 测量值</label><input type="number" id="value-03" placeholder="请输入0.3um数值" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <div><label for="value-05" class="block text-sm font-medium text-gray-700">0.5um 测量值</label><input type="number" id="value-05" placeholder="请输入0.5um数值" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
                <div><label for="value-50" class="block text-sm font-medium text-gray-700">5.0um 测量值</label><input type="number" id="value-50" placeholder="请输入5.0um数值" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500 focus:border-blue-500"></div>
            </div>
            <div class="mt-8 flex justify-end space-x-3"><button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">取消</button><button id="modal-submit" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 flex items-center justify-center min-w-[80px]"><span class="btn-text">提交</span><span class="loader hidden"></span></button></div>
        </div>
    </div>

    <!-- 全局通知 Toast -->
    <div id="toast" class="fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg hidden toast-enter max-w-sm">
        <div class="flex items-center"><i data-lucide="check-circle" class="w-5 h-5 mr-2 flex-shrink-0"></i><span id="toast-message" class="break-words"></span></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const API_BASE_URL = '';
        let state = { currentView: 'dashboard', selectedTask: null };

        const elements = {
            mainContent: document.getElementById('main-content'),
            tabButtons: document.querySelectorAll('.tab-button'),
            modal: document.getElementById('modal'),
            modalSubmit: document.getElementById('modal-submit'),
            modalCancel: document.getElementById('modal-cancel'),
            modalTaskName: document.getElementById('modal-task-name'),
            modalValue03: document.getElementById('value-03'),
            modalValue05: document.getElementById('value-05'),
            modalValue50: document.getElementById('value-50'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
        };

        const api = {
            get: async (endpoint) => {
                const response = await fetch(`${API_BASE_URL}${endpoint}`);
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || `服务器错误，状态码: ${response.status}`);
                return data;
            },
            post: async (endpoint, body) => {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                return response.json();
            }
        };

        const render = async () => {
            updateTabs();
            elements.mainContent.innerHTML = '<div class="text-center py-10"><div class="loader inline-block"></div></div>';
            
            try {
                let viewHTML = '';
                switch (state.currentView) {
                    case 'dashboard': viewHTML = await renderDashboardView(); break;
                    case 'plan': viewHTML = await renderPlanView(); break;
                    case 'furnace': viewHTML = await renderFurnaceView(); break;
                    case 'history': viewHTML = renderHistoryView(); break;
                }
                elements.mainContent.innerHTML = viewHTML;
            } catch (error) {
                console.error("渲染视图时发生错误:", error);
                elements.mainContent.innerHTML = createErrorStateHTML(error.message);
            }
            lucide.createIcons();
        };
        
        const renderDashboardView = async () => {
            const data = await api.get('/api/dashboard');
            // ... 完整看板渲染逻辑 ...
        };

        const renderPlanView = async () => {
            const tasks = await api.get('/api/tasks/pending');
            let content = `<h2 class="text-lg font-semibold text-gray-700 mb-3">今日计划任务</h2><ul class="space-y-3">${tasks.map(createTaskItemHTML).join('')}</ul>`;
            if (tasks.length === 0) content += createEmptyStateHTML('今日计划已全部完成！');
            return content;
        };

        const renderFurnaceView = async () => {
            const allFurnaces = await api.get('/api/furnaces/all_status');
            const pendingFurnaces = allFurnaces.filter(f => !f.measured_this_month);
            const completedFurnaces = allFurnaces.filter(f => f.measured_this_month);

            let content = `
                <div>
                    <h2 class="text-lg font-semibold text-gray-700 mb-3">本月待测固化炉 (${pendingFurnaces.length})</h2>
                    <ul class="space-y-3">
                        ${pendingFurnaces.map(f => createTaskItemHTML({
                            id: f.furnace_id, type: '固化炉', name: f.name,
                            subtext: f.last_measured ? `上次: ${f.last_measured}` : '从未测量',
                            is_completed: false
                        })).join('')}
                    </ul>
                    ${pendingFurnaces.length === 0 ? createEmptyStateHTML('本月固化炉已全部测量！') : ''}
                </div>
                <div class="mt-8">
                    <h2 class="text-lg font-semibold text-gray-700 mb-3">本月已测固化炉 (${completedFurnaces.length})</h2>
                    <ul class="space-y-3">
                         ${completedFurnaces.map(f => createTaskItemHTML({
                            id: f.furnace_id, type: '固化炉', name: f.name,
                            subtext: `本次: ${f.last_measured}`,
                            is_completed: true
                        })).join('')}
                    </ul>
                     ${completedFurnaces.length === 0 ? '<p class="text-sm text-center text-gray-500 py-4">暂无记录</p>' : ''}
                </div>
            `;
            return content;
        };

        const renderHistoryView = () => {
            // ... 完整历史记录渲染逻辑 ...
        };
        
        // --- 事件处理函数 ---
        const handleTabClick = (view) => { state.currentView = view; render(); };
        const handleHistoryQuery = async () => { /* ... */ };
        const handleSubmit = async () => { /* ... */ };
        
        // --- 统一的事件监听 ---
        const addEventListeners = () => {
            elements.tabButtons.forEach(button => button.addEventListener('click', () => handleTabClick(button.dataset.view)));
            elements.modalSubmit.addEventListener('click', handleSubmit);
            elements.modalCancel.addEventListener('click', closeModal);

            elements.mainContent.addEventListener('click', (e) => {
                const recordBtn = e.target.closest('.record-btn');
                if (recordBtn && !recordBtn.disabled) {
                    state.selectedTask = { id: recordBtn.dataset.taskId, type: recordBtn.dataset.taskType, name: recordBtn.dataset.taskName };
                    elements.modalTaskName.textContent = `为 [${state.selectedTask.name}] 记录`;
                    [elements.modalValue03, elements.modalValue05, elements.modalValue50].forEach(el => el.value = '');
                    openModal();
                    return;
                }
                const queryBtn = e.target.closest('#query-history-btn');
                if (queryBtn) {
                    handleHistoryQuery();
                }
            });
        };

        // --- 辅助函数和HTML模板 ---
        const createTaskItemHTML = (task) => {
            const iconMap = { '大环境': 'building-2', '层流棚': 'wind', '加硬机': 'server', '固化炉': 'box' };
            const taskId = task.task_id || task.id;
            const taskName = task.point_name || task.name;
            
            // 固化炉摘要的特殊处理
            if (task.is_summary) {
                return `<li class="bg-gray-50 border border-dashed rounded-lg p-3 flex items-center justify-between"><div class="flex items-center min-w-0"><div class="mr-4 text-green-500"><i data-lucide="${iconMap[task.location_type]}" class="w-6 h-6"></i></div><div class="truncate"><p class="font-semibold text-gray-800 truncate">${task.point_name}</p><p class="text-sm text-gray-500">${task.status}</p></div></div></li>`;
            }

            // 常规任务项
            const isCompleted = task.is_completed;
            const buttonHTML = isCompleted
                ? `<button disabled class="flex-shrink-0 ml-2 px-4 py-2 bg-gray-300 text-gray-500 text-sm font-semibold rounded-md cursor-not-allowed">已录入</button>`
                : `<button data-task-id="${taskId}" data-task-type="${task.type}" data-task-name="${taskName}" class="record-btn flex-shrink-0 ml-2 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold rounded-md">记录</button>`;

            return `<li class="bg-white border border-gray-200 rounded-lg p-3 flex items-center justify-between"><div class="flex items-center min-w-0"><div class="mr-4 text-blue-500"><i data-lucide="${iconMap[task.type] || 'clipboard-list'}" class="w-6 h-6"></i></div><div class="truncate"><p class="font-semibold text-gray-800 truncate">${taskName}</p><p class="text-sm text-gray-500">${task.subtext || '待测量'}</p></div></div>${buttonHTML}</li>`;
        };
        
        // 其他辅助函数...
        const createHistoryItemHTML = (item) => { /* ... */ };
        const createEmptyStateHTML = (text) => { /* ... */ };
        const createErrorStateHTML = (text) => `<div class="text-center py-10"><i data-lucide="alert-triangle" class="w-16 h-16 text-red-500 mx-auto"></i><p class="mt-4 font-semibold text-gray-700">加载失败</p><p class="mt-2 text-sm text-gray-500 break-words">${text}</p></div>`;
        const showToast = (message, isError = false) => { /* ... */ };
        const openModal = () => { /* ... */ };
        const closeModal = () => { /* ... */ };
        const updateTabs = () => { /* ... */ };

        const init = () => {
            addEventListeners();
            handleTabClick('dashboard');
        };
        init();
    });
    </script>
</body>
</html>

